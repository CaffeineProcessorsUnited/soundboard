<!DOCTYPE html>
<html>
  <head>
    <title> Soundboard Player </title>
    <style>
      html{
        margin: 0px;
      }
      body {
        text-align: center;
        margin: 0px;
        padding: 0px;
      }
      header{
        margin: 0px;
        background-color: #FF4FAF;
        padding: 10px;
        color: white;
      }
      h1{
        margin: 0px;
        font-size: 50px;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/util.min.js"></script>
    <script type="text/javascript" src="/assets/js/mespeak.js"></script>
    <script type="text/javascript">
      meSpeak.loadConfig("/assets/json/mespeak_config.json");
    </script>
    <script>
      var loadyoutube=false;
      var player;
      var socket;
      var runtime;
      function objequal(a, b) {
        return subobjequal(a, b) && subobjequal(b, a);
      }
      function subobjequal(a, b) {
        if (typeof a === "object" && typeof b === "object") {
          for (var k in a) {
            if (a.hasOwnProperty(k)) {
              if (b.hasOwnProperty(k)) {
                if (!objequal(a[k], b[k])) {
                  return false;
                }
              } else {
                return false;
              }
            }
          }
        } else {
          if (a != b) {
            return false;
          }
        }
        return true;
      }
      $(document).ready(function() {
        socket = io();
        runtime = new (function(socket, undefined) {
          this.config = {};
          this.path="";
          this.time=0;
          this.playing=false;
          this.service="";
          this.log = function(string) {
            socket.emit("log", { 'log': window.util.format(string) });
            console.log(string);
          }
        })(socket);
        var oldtrackinfo;
        socket.on('get_config', function getConfig(config) {
          runtime.config = config;
          socket.emit('get_current_track');
        });
        socket.on('get_current_track', function loadCurrentTrack(trackinfo) {
          if (objequal(oldtrackinfo, trackinfo)) {
            runtime.log(trackinfo);
            runtime.log("same track! just continue...");
            return;
          }
          oldtrackinfo = trackinfo;
          runtime.log("trackinfo");
          runtime.log(JSON.stringify(trackinfo));
          track = trackinfo["currentTrack"];
          runtime.log(JSON.stringify(track));
          if (!!track) {
            runtime.path = track["path"];
            runtime.time = trackinfo["time"];
            runtime.playing = trackinfo["playing"];
            runtime.service = track["service"];
            runtime.log(runtime.time);
            if (!runtime.config["services"] || !runtime.config["services"][runtime.service]) {
              runtime.log("the server doesnt support this service!");
              socket.emit("next");
              return;
            }
            if (runtime.service == "youtube"){
              $("#soundboard_player").html('<p>Youtube</p><div id="player"></div>');
                if (!loadyoutube) {
                  var tag = document.createElement('script');
                  tag.src = "https://www.youtube.com/iframe_api";
                  var firstScriptTag = document.getElementsByTagName('script')[0];
                  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                  loadyoutube=true;
                } else {
                  onYouTubeIframeAPIReady();
                  runtime.log("reload");
                }
            } else if (runtime.service == "filesystem" || runtime.service == "url") {
              if (runtime.service == "filesystem") {
                if (!!runtime.config["services"] && !!runtime.config["services"][runtime.service] && !!runtime.config["services"][runtime.service]["prefix"]) {
                  runtime.path = runtime.config["services"][runtime.service]["prefix"] + runtime.path;
                  runtime.log(runtime.path);
                }
              }
              $("#soundboard_player").html('<p>' + runtime.service + '</p>');
              player = document.createElement('audio');
              player.addEventListener("ended", function onEnded() {
                socket.emit("next");
              });
              player.addEventListener("pause", function onPause() {
              });
              player.addEventListener("canplay", function onCanPlay() {
                if (runtime.playing == true) {
                  player.play();
                }
              });
              player.addEventListener('loadedmetadata', function onPause() {
                player.currentTime = runtime.time;
              });
              player.src = runtime.path;
              player.controls = true;
              player.currentTime = runtime.time;
              player.load();
              $("#soundboard_player").append(player);
            } else if (runtime.service == "soundcloud") {
              $("#soundboard_player").html('<p>' + track["service"] + '</p>');
              if (!runtime.config["services"] || !runtime.config["services"][runtime.service] || !runtime.config["services"][runtime.service]["apikey"]) {
                runtime.log("you need to specify a soundcloud apikey in the server settings!");
                socket.emit("next");
                return;
              }
              scapikey = runtime.config["services"][runtime.service]["apikey"];
              url = window.location.protocol + '//api.soundcloud.com/resolve?format=json&consumer_key=' + scapikey + '&url=' + encodeURIComponent(runtime.path);
              $.get(url, function(data) {
                if (!!data["stream_url"] && !!data["streamable"]) {
                  player = document.createElement('audio');
                  player.addEventListener("ended", function onEnded() {
                    socket.emit("next");
                  });
                  player.addEventListener("pause", function onPause() {
                    player.play();
                  });
                  player.addEventListener("canplay", function onCanPlay() {
                    if (runtime.playing == true) {
                        player.play();
                    }
                  });
                  player.addEventListener('loadedmetadata', function onPause() {
                    player.currentTime = runtime.time;
                  });
                  player.src = data["stream_url"] + (/\?/.test(data["stream_url"]) ? '&' : '?') + 'consumer_key=' + scapikey;
                  player.controls = true;
                  player.load();
                  $("#soundboard_player").append(player);
                } else {
                  socket.emit("next");
                }
              }).fail(function() {
                socket.emit("next");
              });

              $("#soundboard_player").append(player);
            } else if (runtime.service == "tts") {
              var language = "de";
              if (runtime.config["services"] && runtime.config["services"][runtime.service]) {
                if (runtime.config["services"][runtime.service]["name"]) {
                  $("#soundboard_player").html('<p>' + runtime.config["services"][runtime.service]["name"] + '</p>');
                } else {
                  $("#soundboard_player").html('<p>' + track["service"] + '</p>');
                }
                if (runtime.config["services"][runtime.service]["language"]) {
                  language = runtime.config["services"][runtime.service]["language"];
                }
              }
              meSpeak.loadVoice("/assets/voices/" + language + ".json");
              meSpeak.speak(runtime.path, {}, function() {
                socket.emit("next");
              });
              player = $('<button>Stop</button>');
              player.on('click', function() {
                meSpeak.stop();
                socket.emit("next");
              });
              $("#soundboard_player").append(player);
            } else {
                $("#soundboard_player").html('<p>What the fuck happend?</p>');
            }
          } else {
            runtime.log(track);
            $("#soundboard_player").html('<p>No tracks in queue</p>');
            player = document.createElement('audio');
            player.src = 'songs/default.mp3';
            player.controls = true;
            player.loop = true;
            player.addEventListener("canplay",function onCanPlay() {
              player.play();
            });
            $("#soundboard_player").append(player);
          }
        });
        socket.on('poll', function poll() {
          socket.emit("get_current_track");
        });
        socket.on('get_current_time', function returnCurrentTime() {
          if (runtime.service == "youtube") {
            socket.emit('current_Time', {"time": player.getCurrentTime()});
          } else if (runtime.service == "filesystem" || runtime.service == "url" || runtime.service == "soundcloud") {
            socket.emit('current_Time', {"time": player.currentTime});
          } else {
            runtime.log("no track playing, no time to report");
            runtime.log(runtime);
          }
        });
        socket.emit('get_config');
      });
      function onYouTubeIframeAPIReady() {
        if (runtime.service=="youtube") {
          player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: runtime.path,
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange,
              'onError': onPlayerError
            }
          });
        }
      }
      function onPlayerReady(event) {
        if(runtime.playing==1){
            event.target.setPlaybackQuality('small');
            event.target.seekTo(runtime.time,false);
            event.target.playVideo();
        }
      }
      function onPlayerStateChange(event) {
        runtime.log(event.data);
        if (event.data == YT.PlayerState.PLAYING) {
        } else if (event.data == YT.PlayerState.PAUSED){

        } else if (event.data == YT.PlayerState.ENDED){
          socket.emit('next');
        }
      }
      function onPlayerError(event) {
        socket.emit('next');
      }
      function stopVideo() {
        player.stopVideo();
      }

    </script>
  </head>
  <body>
    <header>
      <h1> Soundboard Player </h1>
    </header>
    <div id="soundboard_player">
    </div>
  </body>
</html>
